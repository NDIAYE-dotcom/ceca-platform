import{a as D,r as h,j as e,L as v,s as f,c as z,i as k,b as F}from"./index-QCmByDZp.js";function R(){const{signOut:c}=D(),[i,b]=h.useState(!1);function p(){b(!0)}function l(){b(!1)}return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"sidebar-toggle","aria-label":"Ouvrir le menu",onClick:p,children:"☰"}),e.jsx("div",{className:"sidebar-overlay "+(i?"show":""),onClick:l}),e.jsxs("aside",{className:"admin-sidebar "+(i?"open":""),"aria-hidden":!i&&window.innerWidth<900,children:[e.jsxs("div",{className:"sidebar-brand",children:[e.jsx("strong",{children:"CECA"}),e.jsx("small",{children:"Admin"}),e.jsx("button",{className:"sidebar-close",onClick:l,"aria-label":"Fermer",children:"×"})]}),e.jsx("nav",{className:"sidebar-nav",children:e.jsxs("ul",{children:[e.jsx("li",{children:e.jsx(v,{to:"/admin",onClick:l,children:"Tableau de bord"})}),e.jsx("li",{children:e.jsx(v,{to:"/admin/formations",onClick:l,children:"Formations"})}),e.jsx("li",{children:e.jsx(v,{to:"/admin/apprenants",onClick:l,children:"Apprenants"})}),e.jsx("li",{children:e.jsx(v,{to:"/admin/certificats",onClick:l,children:"Certificats"})}),e.jsx("li",{children:e.jsx(v,{to:"/admin/instructeurs",onClick:l,children:"Instructeurs"})}),e.jsx("li",{children:e.jsx(v,{to:"/admin/parametres",onClick:l,children:"Paramètres"})})]})}),e.jsx("div",{className:"sidebar-footer",children:e.jsx("button",{className:"btn small",onClick:async()=>{await c(),l()},children:"Déconnexion"})})]})]})}const O="ceca_admin_formations";function B(){try{const c=localStorage.getItem(O);return c?JSON.parse(c):null}catch{return null}}function J(c){try{localStorage.setItem(O,JSON.stringify(c))}catch{}}function P(){const[c,i]=h.useState([]),[b,p]=h.useState(!1),[l,j]=h.useState(null),[d,S]=h.useState({title:"",category:"",duration:"",description:""}),T=!0;h.useEffect(()=>{let a=!0;async function r(){if(T&&f)try{const{data:t,error:s}=await f.from("formations").select("*").order("created_at",{ascending:!1});if(!a)return;if(s&&console.warn("Supabase formations fetch error",s),t&&Array.isArray(t)&&t.length){i(t.map(m=>({...m})));return}}catch(t){console.warn("Supabase fetch failed",t)}const u=B();u&&Array.isArray(u)&&u.length?i(u):i(z.map(t=>({...t})))}return r(),()=>{a=!1}},[]),h.useEffect(()=>{J(c)},[c]);function E(){j(null),S({title:"",category:"",duration:"",description:""}),p(!0)}function _(a){j(a.id),S({title:a.title,category:a.category,duration:a.duration,description:a.description}),p(!0)}function g(a){const{name:r,value:u}=a.target;S(t=>({...t,[r]:u}))}async function w(){if(!d.title.trim())return alert("Titre requis");if(T&&f)try{if(l){const{data:a,error:r}=await f.from("formations").update({title:d.title,category:d.category,duration:d.duration,description:d.description}).eq("id",l).select().maybeSingle();if(r)throw r;i(u=>u.map(t=>t.id===l?{...t,...a}:t))}else{const r={id:String(Date.now()),title:d.title,category:d.category,duration:d.duration,description:d.description,created_at:new Date().toISOString()},{data:u,error:t}=await f.from("formations").insert([r]).select().maybeSingle();if(t)throw t;i(s=>[u||r,...s])}p(!1);return}catch(a){console.warn("Supabase save failed",a),alert("Échec de l'enregistrement sur Supabase — bascuage en mode local")}if(l)i(a=>a.map(r=>r.id===l?{...r,...d}:r));else{const a=String(Date.now());i(r=>[{id:a,...d},...r])}p(!1)}async function C(a){if(window.confirm("Supprimer ce cours ?")){if(T&&f)try{const{error:r}=await f.from("formations").delete().eq("id",a);if(r)throw r;i(u=>u.filter(t=>t.id!==a));return}catch(r){console.warn("Supabase delete failed",r),alert("Échec de la suppression sur Supabase — bascuage en mode local")}i(r=>r.filter(u=>u.id!==a))}}return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Formations"}),e.jsx("p",{className:"muted",children:"Liste des formations disponibles"})]}),e.jsx("div",{children:e.jsx("button",{className:"btn",onClick:E,children:"Nouveau cours"})})]}),e.jsx("div",{style:{marginTop:12,display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(240px,1fr))",gap:12},children:c.map(a=>e.jsxs("div",{className:"card",style:{textAlign:"left"},children:[e.jsx("div",{style:{fontWeight:700},children:a.title}),e.jsxs("div",{className:"muted",style:{fontSize:13},children:[a.category," • ",a.duration]}),e.jsx("div",{style:{marginTop:8,fontSize:14,color:"#333"},children:a.description}),e.jsxs("div",{style:{marginTop:10,display:"flex",gap:8},children:[e.jsx(v,{to:`/formation/${a.id}`,className:"btn small",children:"Voir"}),e.jsx("button",{className:"btn small",onClick:()=>_(a),children:"Éditer"}),e.jsx("button",{className:"btn small",onClick:()=>C(a.id),children:"Supprimer"})]})]},a.id))}),b&&e.jsx("div",{className:"fa-modal",children:e.jsxs("div",{className:"fa-modal-inner",children:[e.jsx("h3",{children:l?"Éditer le cours":"Nouveau cours"}),e.jsxs("label",{children:["Titre",e.jsx("label",{className:"muted",children:e.jsx("input",{name:"title",value:d.title,onChange:g})})]}),e.jsxs("label",{children:["Catégorie",e.jsx("label",{className:"muted",children:e.jsx("input",{name:"category",value:d.category,onChange:g})})]}),e.jsxs("label",{children:["Durée",e.jsx("label",{className:"muted",children:e.jsx("input",{name:"duration",value:d.duration,onChange:g})})]}),e.jsxs("label",{children:["Description",e.jsx("label",{className:"muted",children:e.jsx("textarea",{name:"description",value:d.description,onChange:g,rows:4})})]}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:12},children:[e.jsx("button",{className:"btn",onClick:w,children:l?"Enregistrer":"Créer"}),e.jsx("button",{className:"btn",onClick:()=>p(!1),children:"Annuler"})]})]})})]})}const N="registrations",A="ceca_registrations_deleted";function W(){const[c,i]=h.useState([]),[b,p]=h.useState(!0),[l,j]=h.useState(null),[d,S]=h.useState(null),[T,E]=h.useState(null),[_,g]=h.useState(new Set),[w,C]=h.useState(null);async function a(){p(!0),j(null);try{if(k){const t=n=>{const o=String((n==null?void 0:n.message)||n||"").toLowerCase();return/could not find the table|relation ".+" does not exist|does not exist in the schema cache/.test(o)};let s=await f.from(N).select("*").order("created_at",{ascending:!1});console.debug("Supabase fetch",N,s),S({table:N,dataLength:Array.isArray(s==null?void 0:s.data)?s.data.length:null,error:(s==null?void 0:s.error)||null}),s!=null&&s.error&&!t(s.error)&&j(s.error.message||String(s.error));const m=N==="registrations"?"registration":"registrations";if(s!=null&&s.error&&t(s.error)||Array.isArray(s==null?void 0:s.data)&&s.data.length===0)try{const n=await f.from(m).select("*").order("created_at",{ascending:!1});if(console.debug("Supabase fetch alternate",m,n),!(n!=null&&n.error)&&Array.isArray(n==null?void 0:n.data)&&n.data.length>0){const o=localStorage.getItem(A),x=o?JSON.parse(o):[],y=new Set(Array.isArray(x)?x:[]);g(y),S({table:m,dataLength:n.data.length,error:null});const I=n.data.filter(L=>!y.has(L.id));i(I),p(!1);return}}catch(n){console.warn("Alternate table fetch failed",n)}if(Array.isArray(s==null?void 0:s.data)&&s.data.length>0){const n=localStorage.getItem(A),o=n?JSON.parse(n):[],x=new Set(Array.isArray(o)?o:[]);g(x);const y=s.data.filter(I=>!x.has(I.id));i(y),p(!1);return}}}catch(t){j(String(t))}try{const t=localStorage.getItem("ceca_registrations"),s=t?JSON.parse(t):[],m=localStorage.getItem(A),n=m?JSON.parse(m):[],o=new Set(Array.isArray(n)?n:[]);g(o),i(Array.isArray(s)?s.filter(x=>!o.has(x.id)):[])}catch{i([])}p(!1)}h.useEffect(()=>{a()},[]),h.useEffect(()=>{if(!k)return;const t=[];try{t.push(f.channel(`public:${N}`).on("postgres_changes",{event:"INSERT",schema:"public",table:N},s=>{const m=(s==null?void 0:s.new)??(s==null?void 0:s.record);if(!m)return;const n=localStorage.getItem(A),o=n?JSON.parse(n):[];new Set(Array.isArray(o)?o:[]).has(m.id)||i(y=>y?[m,...y]:[m])}).subscribe())}catch(s){console.warn("realtime subscribe failed",s)}return()=>{try{for(const s of t)f.removeChannel(s)}catch{}}},[k]);async function r(t){if(window.confirm("Supprimer cette inscription (local uniquement) ?")){j(null),E(t);try{const s=localStorage.getItem(A),m=s?JSON.parse(s):[],n=Array.isArray(m)?m:[];n.includes(t)||n.push(t),localStorage.setItem(A,JSON.stringify(n)),g(new Set(n));const o=(c||[]).filter(x=>x.id!==t);i(o)}catch(s){console.error("local delete failed",s),j(String(s)),window.alert("Erreur suppression locale: "+String(s))}E(null)}}function u(){if(!c||c.length===0)return;const t=["id","formation_id","formation_title","name","email","phone","organization","payment_method","notes","created_at"],s=[t.join(",")].concat(c.map(x=>t.map(y=>`"${(x[y]||"").toString().replace(/"/g,'""')}"`).join(","))).join(`
`),m=new Blob([s],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(m),o=document.createElement("a");o.href=n,o.download="ceca_registrations.csv",o.click(),URL.revokeObjectURL(n)}return b?e.jsx("div",{className:"admin-card",children:"Chargement des apprenants…"}):e.jsxs("div",{className:"admin-card admin-apprenants",children:[l&&e.jsxs("div",{style:{background:"#ffe6e6",padding:10,color:"#700",borderRadius:6,marginBottom:12},children:["Erreur: ",l]}),e.jsxs("div",{className:"admin-card-header",children:[e.jsx("h3",{children:"Inscriptions / Apprenants"}),e.jsxs("div",{children:[e.jsx("button",{className:"btn",onClick:a,children:"Rafraîchir"}),e.jsx("button",{className:"btn secondary",onClick:u,children:"Exporter CSV"})]})]}),w&&e.jsx("div",{className:"modal-backdrop",onClick:()=>C(null),children:e.jsxs("div",{className:"modal-card",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10},children:[e.jsx("h3",{children:"Détails de l'inscription"}),e.jsx("button",{className:"btn secondary",onClick:()=>C(null),children:"Fermer"})]}),e.jsx("div",{style:{fontSize:14,lineHeight:1.5},children:Object.keys(w).map(t=>e.jsxs("div",{style:{marginBottom:8},children:[e.jsxs("strong",{style:{textTransform:"capitalize"},children:[t.replace(/_/g," "),":"]})," ",String(w[t]??"—")]},t))})]})}),(!c||c.length===0)&&e.jsx("div",{className:"muted",children:"Aucune inscription trouvée."}),e.jsx("div",{className:"apprenants-list",children:(c||[]).map(t=>e.jsxs("div",{className:"apprenant-row",children:[e.jsxs("div",{className:"apprenant-main",children:[e.jsxs("div",{className:"apprenant-name",children:[t.name," ",e.jsxs("span",{className:"muted",children:["• ",t.email]})]}),e.jsxs("div",{className:"apprenant-meta",children:["Formation: ",e.jsx("strong",{children:t.formation_title})," — ",t.created_at?new Date(t.created_at).toLocaleString():"—"]})]}),e.jsxs("div",{className:"apprenant-actions",children:[e.jsx("button",{className:"btn secondary",onClick:()=>C(t),children:"Détails"}),e.jsx("button",{className:"btn",onClick:()=>r(t.id),children:"Supprimer"})]})]},t.id))})]})}function U(){const{user:c,loading:i}=D(),p=F().pathname.replace(/^\/admin\/?/,""),l=p===""?"dashboard":p;function j(d){switch(d){case"formations":return e.jsx(P,{});case"apprenants":return e.jsx(W,{});case"certificats":return e.jsxs("div",{children:[e.jsx("h2",{children:"Certificats"}),e.jsx("p",{className:"muted",children:"Génération et gestion des certificats (placeholder)"}),e.jsx("div",{style:{marginTop:12},className:"card",children:"Aucun certificat généré — placeholder"})]});case"instructeurs":return e.jsxs("div",{children:[e.jsx("h2",{children:"Instructeurs"}),e.jsx("p",{className:"muted",children:"Liste des instructeurs (placeholder)"}),e.jsx("div",{style:{marginTop:12},className:"card",children:"Aucun instructeur — placeholder"})]});case"parametres":return e.jsxs("div",{children:[e.jsx("h2",{children:"Paramètres"}),e.jsx("p",{className:"muted",children:"Configuration du site (placeholder)"}),e.jsx("div",{style:{marginTop:12},className:"card",children:"Options de configuration — placeholder"})]});default:return e.jsxs("div",{children:[e.jsx("h2",{children:"Tableau de bord"}),e.jsx("p",{className:"muted",children:"Vue d'ensemble (placeholder)"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(200px,1fr))",gap:12,marginTop:12},children:[e.jsx("div",{className:"card",children:"Formations: —"}),e.jsx("div",{className:"card",children:"Apprenants: —"}),e.jsx("div",{className:"card",children:"Certificats: —"}),e.jsx("div",{className:"card",children:"Instructeurs: —"})]})]})}}return e.jsx("section",{className:"container admin-page",children:e.jsxs("div",{className:"admin-layout",children:[e.jsx(R,{}),e.jsxs("main",{className:"admin-main",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:12},children:[e.jsxs("div",{children:[e.jsx("h1",{children:"Espace administration"}),e.jsx("p",{style:{marginTop:6,opacity:.9},children:"Prototype de tableau de bord — aperçu professionnel pour vérification."})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{fontSize:12,color:"#666"},children:"Mode"}),e.jsx("div",{style:{background:"#ffe9b3",color:"#7a4a00",padding:"6px 10px",borderRadius:6,fontWeight:600},children:"Preview (no DB)"})]})]}),e.jsx("div",{style:{marginTop:18},children:j(l)}),e.jsxs("div",{className:"admin-stats",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:12,marginTop:18},children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{style:{fontSize:20,fontWeight:700},children:"—"}),e.jsx("div",{style:{fontSize:12,opacity:.7},children:"Formations"})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{style:{fontSize:20,fontWeight:700},children:"—"}),e.jsx("div",{style:{fontSize:12,opacity:.7},children:"Apprenants"})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{style:{fontSize:20,fontWeight:700},children:"—"}),e.jsx("div",{style:{fontSize:12,opacity:.7},children:"Certificats"})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{style:{fontSize:20,fontWeight:700},children:"—"}),e.jsx("div",{style:{fontSize:12,opacity:.7},children:"Instructeurs"})]})]}),e.jsx("h2",{style:{marginTop:22},children:"Actions rapides"}),e.jsxs("div",{className:"admin-grid",style:{marginTop:10},children:[e.jsx("div",{className:"card",children:e.jsxs("div",{children:[e.jsx("strong",{children:"Ajouter une formation"}),e.jsx("div",{className:"muted",children:"Formulaire d'ajout (placeholder)"}),e.jsx("div",{style:{marginTop:10},children:e.jsx("button",{className:"btn",children:"Nouveau cours"})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{children:[e.jsx("strong",{children:"Gérer apprenants"}),e.jsx("div",{className:"muted",children:"Importer / Exporter (placeholder)"}),e.jsx("div",{style:{marginTop:10},children:e.jsx("button",{className:"btn",children:"Voir la liste"})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{children:[e.jsx("strong",{children:"Générer certificats"}),e.jsx("div",{className:"muted",children:"Génération manuelle (placeholder)"}),e.jsx("div",{style:{marginTop:10},children:e.jsx("button",{className:"btn",children:"Générer"})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{children:[e.jsx("strong",{children:"Paramètres"}),e.jsx("div",{className:"muted",children:"Configuration du site"}),e.jsx("div",{style:{marginTop:10},children:e.jsx("button",{className:"btn",children:"Ouvrir"})})]})})]}),e.jsx("div",{style:{marginTop:24,color:"#555"},children:e.jsx("p",{children:"Note : ceci est une interface de démonstration. Les actions sont des placeholders en attente de connexion à la base de données."})})]})]})})}export{U as default};
